{#
/**
 * @file
 * Theme override for a field.
 *
 * To override output, copy the "field.html.twig" from the templates directory
 * to your theme's directory and customize it, just like customizing other
 * Drupal templates such as page.html.twig or node.html.twig.
 *
 * Instead of overriding the theming for all fields, you can also just override
 * theming for a subset of fields using
 * @link themeable Theme hook suggestions. @endlink For example,
 * here are some theme hook suggestions that can be used for a field_foo field
 * on an article node type:
 * - field--node--field-foo--article.html.twig
 * - field--node--field-foo.html.twig
 * - field--node--article.html.twig
 * - field--field-foo.html.twig
 * - field--text-with-summary.html.twig
 * - field.html.twig
 *
 * Available variables:
 * - attributes: HTML attributes for the containing element.
 * - label_hidden: Whether to show the field label or not.
 * - title_attributes: HTML attributes for the title.
 * - label: The label for the field.
 * - multiple: TRUE if a field can contain multiple items.
 * - items: List of all the field items. Each item contains:
 *   - attributes: List of HTML attributes for each item.
 *   - content: The field item's content.
 * - entity_type: The entity type to which the field belongs.
 * - field_name: The name of the field.
 * - field_type: The type of the field.
 * - label_display: The display settings for the label.
 *
 * @see template_preprocess_field()
 */
#}

{# sort items by time_from #}
{% set items = items|sort((a, b) => a.content['#variables'].time_from <=> b.content['#variables'].time_from) %}


<div class="mb-5 mx-3 mx-lg-0">
  {# Headers for table like expirence on larger screens. #}
  <div class="row row-gap-2 py-2 d-none d-lg-flex">
    <label class="col-lg-2 col-xl-1 fw-bold small text-body-secondary">{{ 'Location'|t }}</label>
    <label class="col-lg-2 fw-bold small text-body-secondary">{{ 'Date'|t }}</label>
    <label class="col-lg-2 fw-bold small text-body-secondary">{{ 'Time'|t }}</label>
    <label class="col-lg-3 fw-bold small text-body-secondary">{{ 'Address'|t }}</label>
    <label class="col-lg-1 fw-bold small text-body-secondary">{{ 'Spots'|t }}</label>
    <label class="col-lg-2 col-xl-3 fw-bold small text-body-secondary">{{ 'Registration'|t }}</label>
  </div>
  <div class="d-flex flex-column gap-4">
    {% for item in items %}
      {% set variables = item.content['#variables'] %}
      {% set node = variables['entity'] %}
      {% set meeting_cancelled = public_meeting_helper.isCancelled(node) %}
      {% set meeting_has_been_held = public_meeting_helper.hasBeenHeld(node) %}
      {% set registration_deadline_passed = public_meeting_helper.isDeadlinePassed(node) %}
      {% set sign_up_url = public_meeting_helper.getPretixSignUpUrl(variables.data) %}
      {% set availability = public_meeting_helper.getPretixAvailability(variables.data) %}

      {% set is_previous = variables.uuid == public_meeting_context.previous.uuid %}
      {% set is_current = variables.uuid == public_meeting_context.current.uuid %}
      {% set is_next = variables.uuid == public_meeting_context.next.uuid %}
      {% set is_first_upcoming = variables.uuid == public_meeting_context.upcoming[0].uuid %}

      {{ dump({is_previous, is_current, is_next, is_first_upcoming}) }}

      <div class="row row-gap-2 bg-white py-2 position-relative {% if item.active %}pt-3{% endif%}">

        {% if item.active %}
          <span class="position-absolute top-0 start-0 translate-middle-y ms-2 bg-primary text-white rounded w-auto">{{ 'Next event'|t }}</span>
        {% endif %}

        <div class="col-auto col-sm-5 col-lg-2 col-xl-1">
          <label class="d-block d-lg-none fw-bold small text-body-secondary">{{ 'Location'|t }}</label>
          {{ variables.location }}
        </div>
        
        <div class="col-12 col-sm-6 col-lg-2">
          <label class="d-block d-lg-none fw-bold small text-body-secondary">{{ 'Date'|t }}</label>
          <span class="fw-bold">{{ variables.time_from|date('U')|format_date('hoeringsportal_date_long') }}</small>
        </div>
        
        <div class="col-12 col-sm-5 col-lg-2">
          <label class="d-block d-lg-none fw-bold small text-body-secondary">{{ 'Time'|t }}</label>
          {{ variables.time_from|date('U')|format_date('hoeringsportal_time') }}â€“{{ variables.time_to|date('U')|format_date('hoeringsportal_time') }}
        </div>
        
        <div class="col-12 col-sm-7 col-lg-3">
          <label class="d-block d-lg-none fw-bold small text-body-secondary">{{ 'Address'|t }}</label>
          {{ variables.address }}
        </div>
        
        <div class="col-12 col-sm-5 col-lg-1">
          <label class="d-block d-lg-none fw-bold small text-body-secondary">{{ 'Spots'|t }}</label>
          {% if availability.available_number|default(false) %}
            {{ availability.available_number }}/{{ availability.total_size }}
          {% else %}
            {{ variables.spots }}/{{ variables.spots }}
          {% endif %}
        </div>
        
        <div class="col-auto col-sm-7 col-lg-2 col-xl-3">
          <label class="d-block d-lg-none fw-bold small text-body-secondary">{{ 'Registration'|t }}</label>
          {% if meeting_cancelled %}
            <div class="meeting-has-been-cancelled text-danger">{{ 'Meeting has been cancelled'|t }}</div>
          {% elseif meeting_has_been_held %}
            <div class="meeting-has-been-held">{{ 'Meeting has already been held'|t }}</div>
          {% else %}
            {% if registration_deadline_passed %}
              <div class="">{{ 'Registration deadline passed'|t }}</div>
            {% elseif sign_up_url %}
              <a href="{{ sign_up_url }}" class="btn btn-primary btn-sm public-meeting-sign-up" target="_blank">
                {{ 'Sign up'|t }}
                <span class="sr-only">({{ 'Opens in a new tab'|trans }})</span>
              </a>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>
